<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel Explorer - Treino Contínuo Anhanguera</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Fira Code', monospace; background-color: #020617; } /* bg-slate-950 */
        .font-sans { font-family: 'Inter', sans-serif; }
        
        /* Animações Customizadas */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes bounceGlow { 
            0%, 100% { transform: translateY(0); filter: drop-shadow(0 0 10px rgba(239,68,68,0.9)); } 
            50% { transform: translateY(-5px); filter: drop-shadow(0 0 15px rgba(239,68,68,1)); } 
        }
        @keyframes pulseCombo {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 10px rgba(245,158,11,0.8)); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
        }
        @keyframes floatUpFade {
            0% { opacity: 1; transform: translateY(0) scale(1.2); }
            100% { opacity: 0; transform: translateY(-50px) scale(1); }
        }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-bug { animation: bounceGlow 1.5s infinite; }
        .animate-combo { animation: pulseCombo 1s infinite; }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        
        .floating-text {
            position: absolute;
            pointer-events: none;
            font-weight: 900;
            font-family: 'Inter', sans-serif;
            z-index: 50;
            animation: floatUpFade 1.5s ease-out forwards;
        }

        .hidden { display: none !important; }

        /* Estilização da grelha */
        #grid-container {
            touch-action: none; 
        }
    </style>
</head>
<body class="text-slate-200 flex flex-col items-center select-none overflow-x-hidden min-h-screen relative">

    <!-- Container de Notificações Flutuantes -->
    <div id="float-container" class="fixed inset-0 pointer-events-none z-50 overflow-hidden"></div>

    <!-- HEADER / HUD -->
    <header id="hud" class="hidden w-full max-w-5xl bg-slate-900 border-b border-cyan-900/50 p-3 sm:p-4 flex flex-col sm:flex-row justify-between items-center sticky top-0 z-40 shadow-[0_0_15px_rgba(0,255,255,0.05)] gap-3">
        <div class="flex items-center gap-3 text-cyan-400 font-bold text-lg md:text-xl tracking-widest">
            <i class="ph-fill ph-terminal-window text-2xl"></i> <span id="hud-level-text">SETOR 1</span>
        </div>
        
        <div class="flex items-center gap-2 sm:gap-4 flex-wrap justify-center">
            <!-- Barra de Combo -->
            <div id="hud-combo" class="hidden items-center gap-1 bg-orange-900/40 px-3 py-1.5 rounded-lg border border-orange-500/50 text-orange-400 font-black shadow-[0_0_10px_rgba(249,115,22,0.3)] animate-combo">
                <i class="ph-fill ph-fire text-lg"></i> COMBO x<span id="combo-multiplier">1</span>
            </div>

            <div class="flex items-center gap-2 bg-slate-800/80 px-3 sm:px-4 py-1.5 rounded-lg border border-yellow-600/30 text-yellow-500 font-bold shadow-inner">
                <i class="ph-fill ph-lightning text-lg"></i> <span id="hud-xp">0</span> BITS
            </div>
            
            <div id="hud-hp-container" class="flex items-center gap-2 px-3 sm:px-4 py-1.5 rounded-lg border font-bold shadow-inner transition-all duration-300 bg-emerald-900/30 border-emerald-500/50 text-emerald-400">
                <i class="ph-fill ph-heart text-lg"></i> <span id="hud-hp">100</span>%
            </div>

            <button onclick="logout()" class="ml-2 flex items-center justify-center p-2 rounded-lg bg-red-900/40 text-red-400 hover:bg-red-800/60 hover:text-red-200 border border-red-800/50 transition-colors" title="Desconectar">
                <i class="ph-bold ph-sign-out text-lg"></i>
            </button>
        </div>
    </header>

    <main id="main-content" class="flex-1 w-full max-w-5xl flex flex-col items-center justify-center p-2 sm:p-4 relative">
        
        <!-- CARREGAMENTO -->
        <div id="screen-loading" class="flex flex-col items-center justify-center w-full h-full min-h-[50vh]">
            <i class="ph ph-spinner-gap animate-spin text-cyan-500 text-6xl mb-4"></i>
            <p class="text-cyan-500 font-mono tracking-widest uppercase text-center px-4">Iniciando Kernel Explorer...</p>
        </div>

        <!-- AUTH -->
        <div id="screen-auth" class="hidden w-full max-w-md animate-fade-in relative z-50 my-auto pt-10">
            <div class="bg-slate-900/90 p-8 rounded-3xl border border-cyan-800/50 shadow-[0_20px_50px_rgba(0,255,255,0.05)] text-center relative overflow-hidden backdrop-blur-sm">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>
                <i class="ph-fill ph-fingerprint text-cyan-500 text-6xl mx-auto mb-4 drop-shadow-[0_0_15px_rgba(0,255,255,0.3)] inline-block"></i>
                <h2 class="text-2xl font-black text-white mb-2 tracking-wide font-sans uppercase">Autenticação</h2>
                <p class="text-slate-400 text-sm mb-6 font-sans">Identifique-se para gravar seu progresso na memória não-volátil.</p>

                <form id="auth-form" class="space-y-4 text-left" onsubmit="event.preventDefault();">
                    <div>
                        <label class="block text-cyan-400 text-xs font-bold mb-1 tracking-widest uppercase">E-mail Acadêmico ou Pessoal</label>
                        <input type="email" id="auth-email" required class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all font-sans" placeholder="aluno@anhanguera.com">
                    </div>
                    <div>
                        <label class="block text-cyan-400 text-xs font-bold mb-1 tracking-widest uppercase">Senha de Acesso</label>
                        <input type="password" id="auth-password" required minlength="6" class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all font-sans" placeholder="Mínimo 6 caracteres">
                    </div>
                    
                    <div id="auth-error" class="hidden text-red-400 text-xs font-bold p-3 bg-red-950/50 border border-red-900 rounded-lg text-center font-sans"></div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="handleAuth('login', event)" class="flex-1 bg-cyan-700 hover:bg-cyan-600 text-white p-3 rounded-xl font-bold tracking-widest uppercase transition-all shadow-[0_0_15px_rgba(6,182,212,0.3)] border border-cyan-500 text-sm flex justify-center items-center gap-2">
                            <i class="ph-bold ph-sign-in"></i> Entrar
                        </button>
                        <button type="button" onclick="handleAuth('register', event)" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 p-3 rounded-xl font-bold tracking-widest uppercase transition-all border border-slate-600 text-sm flex justify-center items-center gap-2">
                            <i class="ph-bold ph-user-plus"></i> Novo
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- DASHBOARD (NOVO MENU INFINITO) -->
        <div id="screen-dashboard" class="hidden w-full max-w-2xl animate-fade-in my-auto">
            <div class="bg-slate-900/80 p-8 md:p-12 rounded-3xl border border-cyan-800/50 shadow-[0_20px_50px_rgba(0,255,255,0.05)] text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>
                
                <i class="ph-fill ph-cpu text-cyan-500 text-7xl mx-auto mb-6 drop-shadow-[0_0_15px_rgba(0,255,255,0.3)] inline-block"></i>
                <h2 class="text-3xl sm:text-4xl font-black text-white mb-2 tracking-wide font-sans">Sistemas Operacionais</h2>
                <p class="text-slate-400 text-sm md:text-base mb-8 font-sans">
                    Modo Infinito. Os bugs (vermelhos) agora caçam-no pelo mapa.
                </p>
                
                <div class="grid grid-cols-2 gap-4 mb-10 max-w-lg mx-auto">
                    <div class="bg-slate-950 border border-slate-800 p-4 rounded-xl">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-1">Setor Recorde</div>
                        <div class="text-2xl font-black text-cyan-400" id="dash-max-floor">1</div>
                    </div>
                    <div class="bg-slate-950 border border-slate-800 p-4 rounded-xl">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-1">Bits Totais</div>
                        <div class="text-2xl font-black text-yellow-500 flex items-center justify-center gap-1">
                            <i class="ph-fill ph-lightning"></i> <span id="dash-xp">0</span>
                        </div>
                    </div>
                </div>
                
                <button onclick="startLevel()" class="w-full bg-cyan-700 hover:bg-cyan-600 border-2 border-cyan-400 text-white px-8 py-5 rounded-2xl font-black tracking-widest uppercase transition-all shadow-[0_0_20px_rgba(6,182,212,0.3)] hover:shadow-[0_0_30px_rgba(6,182,212,0.5)] flex items-center justify-center gap-3 text-lg">
                    <i class="ph-fill ph-play"></i> INICIAR TREINO
                </button>
            </div>
        </div>

        <!-- JOGANDO (MAPA) -->
        <div id="screen-playing" class="hidden w-full flex flex-col items-center animate-fade-in">
            <div class="mb-4 flex items-center justify-between w-full max-w-2xl bg-slate-800/80 px-4 py-3 rounded-xl border border-slate-700 shadow-lg">
                <span id="playing-level-name" class="text-cyan-400 font-bold uppercase tracking-wider text-sm sm:text-base truncate mr-4">Tema: Fundamentos</span>
                <button onclick="abortGame()" class="text-slate-400 hover:text-red-400 text-xs font-bold uppercase tracking-widest transition-colors flex-shrink-0 flex items-center gap-1">
                    <i class="ph-bold ph-power"></i> Abortar
                </button>
            </div>

            <div id="grid-container" class="bg-slate-950 border-4 border-slate-800 rounded-xl p-1 sm:p-2 shadow-[0_10px_40px_rgba(0,0,0,0.8)] grid gap-[1px] sm:gap-[2px] max-w-full overflow-x-auto">
                <!-- Gerado via JS -->
            </div>

            <!-- CONTROLES MOBILE -->
            <div class="mt-8 grid grid-cols-3 gap-2 w-48 sm:w-56 mx-auto lg:hidden">
                <div></div>
                <button onclick="movePlayer(-1, 0)" class="bg-slate-800 p-5 rounded-2xl flex justify-center active:bg-cyan-900 active:scale-95 border-b-4 border-slate-900 shadow-lg transition-transform"><i class="ph-bold ph-caret-up text-white text-2xl"></i></button>
                <div></div>
                <button onclick="movePlayer(0, -1)" class="bg-slate-800 p-5 rounded-2xl flex justify-center active:bg-cyan-900 active:scale-95 border-b-4 border-slate-900 shadow-lg transition-transform"><i class="ph-bold ph-caret-left text-white text-2xl"></i></button>
                <button onclick="movePlayer(1, 0)" class="bg-slate-800 p-5 rounded-2xl flex justify-center active:bg-cyan-900 active:scale-95 border-b-4 border-slate-900 shadow-lg transition-transform"><i class="ph-bold ph-caret-down text-white text-2xl"></i></button>
                <button onclick="movePlayer(0, 1)" class="bg-slate-800 p-5 rounded-2xl flex justify-center active:bg-cyan-900 active:scale-95 border-b-4 border-slate-900 shadow-lg transition-transform"><i class="ph-bold ph-caret-right text-white text-2xl"></i></button>
            </div>
            <p class="mt-6 text-slate-500 text-xs hidden lg:block uppercase tracking-widest font-bold">Atenção: Os Bugs movem-se sozinhos. Seja rápido.</p>
        </div>

        <!-- BATALHA -->
        <div id="screen-battle" class="hidden w-full max-w-3xl bg-slate-900 border-2 border-red-900/80 rounded-3xl p-6 md:p-10 shadow-[0_20px_50px_rgba(239,68,68,0.15)] animate-slide-up my-4">
            <div class="flex items-center gap-4 mb-6 md:mb-8 border-b border-red-900/50 pb-5">
                <div class="p-3 md:p-4 bg-red-950 rounded-2xl border border-red-900 shadow-inner">
                    <i class="ph-fill ph-bug text-red-500 text-3xl md:text-4xl animate-pulse"></i>
                </div>
                <div>
                    <h2 class="text-xl md:text-2xl font-black text-red-400 uppercase tracking-widest">Colisão Detetada</h2>
                    <p class="text-red-500/70 text-xs md:text-sm font-sans mt-1">O tempo parou. Prove o seu conhecimento.</p>
                </div>
            </div>
            
            <p id="battle-question" class="text-lg md:text-2xl text-white mb-8 leading-relaxed font-sans font-semibold border-l-4 border-cyan-500 pl-4"></p>

            <div id="battle-options" class="space-y-3 font-sans"></div>

            <div id="battle-feedback-panel" class="hidden mt-8 animate-fade-in">
                <div id="feedback-box" class="p-6 md:p-8 rounded-2xl border-2 mb-6 shadow-lg">
                    <div class="flex items-center gap-3 mb-4">
                        <i id="feedback-icon" class="text-3xl"></i>
                        <h3 id="feedback-title" class="font-black uppercase tracking-widest text-lg md:text-xl"></h3>
                    </div>
                    <p id="feedback-text" class="leading-relaxed text-base md:text-lg font-sans text-slate-200"></p>
                    <div id="feedback-warning" class="hidden mt-5 bg-red-900/40 border border-red-800/50 p-4 rounded-xl flex items-start gap-3">
                        <i class="ph-fill ph-warning-circle text-red-400 text-xl mt-0.5"></i>
                        <p class="text-sm md:text-base text-red-300 font-medium">O Bug sobreviveu e continua a perseguir. Fuja ou ataque novamente.</p>
                    </div>
                </div>
                
                <button onclick="closeBattleFeedback()" id="btn-continue-battle" class="w-full bg-slate-800 hover:bg-cyan-900 hover:text-cyan-300 text-white font-black py-5 rounded-2xl border border-slate-600 hover:border-cyan-500 uppercase tracking-widest transition-all duration-300 shadow-[0_10px_20px_rgba(0,0,0,0.3)] text-sm md:text-base">
                    Continuar
                </button>
            </div>
        </div>

        <!-- GAME OVER -->
        <div id="screen-game-over" class="hidden text-center animate-slide-up bg-slate-900 border-2 border-red-900/50 p-8 md:p-12 rounded-3xl shadow-[0_20px_50px_rgba(239,68,68,0.2)] max-w-2xl w-full">
            <i class="ph-fill ph-warning-octagon text-red-600 text-7xl md:text-8xl mx-auto mb-6 inline-block animate-pulse"></i>
            <h1 class="text-4xl md:text-6xl font-black text-red-500 mb-4 tracking-widest uppercase">Kernel Panic</h1>
            <div class="w-20 h-1 bg-red-800 mx-auto mb-6"></div>
            <p class="text-slate-300 mb-10 text-base md:text-lg font-sans leading-relaxed">
                A integridade do sistema atingiu <span class="text-red-400 font-bold">0%</span>. O setor colapsou.<br><br>
                A repetição espaçada é o segredo do sucesso. O seu cérebro já gravou a falha, levante-se e tente outra vez.
            </p>
            <button onclick="setGameState('dashboard')" class="w-full sm:w-auto bg-red-900 hover:bg-red-800 border-2 border-red-500 text-white px-10 py-5 rounded-2xl font-black tracking-widest uppercase transition-all shadow-[0_0_20px_rgba(239,68,68,0.3)] hover:shadow-[0_0_30px_rgba(239,68,68,0.5)]">
                Recalibrar Sistema
            </button>
        </div>

        <!-- LEVEL COMPLETE (TRANSIÇÃO RÁPIDA) -->
        <div id="screen-level-complete" class="hidden text-center animate-slide-up bg-slate-900 border-2 border-emerald-900/50 p-8 md:p-12 rounded-3xl shadow-[0_20px_50px_rgba(16,185,129,0.1)] w-full max-w-2xl">
            <i class="ph-fill ph-check-circle text-emerald-500 text-7xl md:text-8xl mx-auto mb-6 inline-block"></i>
            <h1 class="text-3xl md:text-5xl font-black text-emerald-400 mb-4 tracking-widest uppercase">Setor Limpo</h1>
            <div class="w-20 h-1 bg-emerald-800 mx-auto mb-6"></div>
            <p class="text-slate-300 mb-8 text-lg font-sans">Avançando profundamente no Sistema Operacional...</p>
            
            <div class="bg-slate-950 border-2 border-emerald-900/50 p-6 md:p-8 rounded-2xl inline-block mb-10 shadow-inner w-full sm:w-auto">
                <div class="text-emerald-500 text-xs md:text-sm font-bold tracking-widest uppercase mb-3">Recompensa de Piso</div>
                <div class="text-4xl md:text-6xl font-black text-yellow-500 flex items-center justify-center gap-3 drop-shadow-[0_0_15px_rgba(234,179,8,0.5)]">
                    <i class="ph-fill ph-lightning"></i> +500 BITS
                </div>
            </div>

            <div>
                <button onclick="nextFloor()" class="w-full sm:w-auto bg-emerald-900 hover:bg-emerald-800 border-2 border-emerald-500 text-white px-10 py-5 rounded-2xl font-black tracking-widest uppercase transition-all shadow-[0_0_20px_rgba(16,185,129,0.3)] hover:shadow-[0_0_30px_rgba(16,185,129,0.5)]">
                    Avançar para o Próximo Setor
                </button>
            </div>
        </div>

    </main>

    <!-- LOGIC SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONTEÚDO EDUCACIONAL EXPANDIDO (Unidade 1 - Anhanguera CS) ---
        const QUESTIONS_POOL = {
            level1: [ 
                { q: "Qual é a definição exata de Sistema Operacional segundo o material?", options: [ { text: "Um hardware dedicado a traduzir linguagem de máquina.", isCorrect: false, exp: "Incorreto. É um software." }, { text: "Um conjunto de rotinas executado pelo processador que gerencia recursos de hardware e software.", isCorrect: true, exp: "Correto! Controla o funcionamento do computador gerenciando CPU, memória e dispositivos de Entrada/Saída." }, { text: "Um programa que funciona apenas como antivírus do hardware.", isCorrect: false, exp: "Falso. O SO é a base do sistema, não apenas um utilitário de segurança." } ] },
                { q: "No modelo de camadas do sistema computacional, qual é a hierarquia correta de comunicação?", options: [ { text: "Usuário -> Hardware -> Sistema Operacional -> Aplicação", isCorrect: false, exp: "Ordem errada. O usuário não acede diretamente ao hardware." }, { text: "Usuários -> Aplicações -> Sistema Operacional -> Hardware", isCorrect: true, exp: "Exato! O S.O. é a ponte intermediária estrutural entre as aplicações de alto nível e o hardware físico subjacente." } ] },
                { q: "O que significa dizer que o S.O. atua como uma 'Máquina Estendida' (ou Máquina Virtual)?", options: [ { text: "Oculta a complexidade física do hardware, oferecendo aos programadores uma abstração lógica, limpa e padronizada.", isCorrect: true, exp: "Correto! Ele trata hardwares complexos como abstrações simples (ex: enxerga um disco rígido complexo apenas como 'arquivos e pastas')." }, { text: "Ele emula diferentes sistemas operativos secundários simultaneamente.", isCorrect: false, exp: "Isso refere-se a software de virtualização (hypervisors), não à definição primordial de Máquina Estendida do SO." } ] },
                { q: "Qual é a característica temporal do S.O. em relação ao ciclo de vida de uso do computador?", options: [ { text: "É o último programa a ser carregado na memória RAM após a interface gráfica.", isCorrect: false, exp: "Incorreto. Ele deve ser o primeiro." }, { text: "É o primeiro programa a ser executado no boot e o último a ser encerrado no shutdown.", isCorrect: true, exp: "Exato! O processo de boot (bootstrap) carrega o núcleo do SO para gerir todo o resto." } ] },
                { q: "Além de ser uma Máquina Estendida, o Sistema Operacional também é classificado como um:", options: [ { text: "Gerenciador de Recursos (Resource Manager).", isCorrect: true, exp: "Correto! Ele atua como um árbitro, alocando CPU, memória e periféricos de forma justa e eficiente para programas concorrentes." }, { text: "Compilador de código-fonte.", isCorrect: false, exp: "Compiladores são ferramentas de desenvolvimento (software de sistema), mas não são o Sistema Operacional em si." } ] }
            ],
            level2: [ 
                { q: "Qual é a maior desvantagem arquitetural dos sistemas Monoprogramáveis (Monotarefa), como o MS-DOS?", options: [ { text: "Eles dividem o processador entre muitas tarefas, causando sobrecarga de preempção (overhead).", isCorrect: false, exp: "Isso é um desafio da multitarefa, não do monotarefa." }, { text: "Não há compartilhamento de recursos. Se um programa aguarda um dado (E/S), o processador fica totalmente ocioso.", isCorrect: true, exp: "Correto! Este modelo desperdiça poder computacional drásticamente, pois a CPU tem de esperar por periféricos lentos." } ] },
                { q: "Quais são as características fundamentais de um Sistema de Processamento em Lote (Batch)?", options: [ { text: "Agrupa tarefas (jobs) semelhantes e executa-as sequencialmente sem exigir a interação do utilizador durante o processamento.", isCorrect: true, exp: "Perfeito! Muito usado na era dos mainframes para maximizar a utilização da CPU, sacrificando a interatividade." }, { text: "Exige que o utilizador valide cada instrução executada em tempo real.", isCorrect: false, exp: "No Batch, o processamento é offline/desacoplado do utilizador." } ] },
                { q: "Nos Sistemas Multiprogramáveis, o conceito de 'Tempo Compartilhado' (Time-Sharing) refere-se a quê?", options: [ { text: "A CPU é dedicada a um único utilizador num horário agendado.", isCorrect: false, exp: "Isso seria agendamento humano, não arquitetura de SO." }, { text: "O S.O. fatia o tempo do processador (quantum) alternando rapidamente entre processos, criando a ilusão de execução simultânea.", isCorrect: true, exp: "Correto! É a base da interatividade moderna. O SO executa uma troca de contexto (context switch) a cada fatia de tempo." } ] },
                { q: "Na transição para sistemas mais eficientes, o que é o 'Spooling' (Simultaneous Peripheral Operation On-Line)?", options: [ { text: "Uma técnica de utilizar memória secundária (disco) como um buffer temporário para tarefas de E/S (ex: fila de impressão), libertando a CPU.", isCorrect: true, exp: "Exatamente! Permite que a CPU não fique bloqueada a esperar por um dispositivo muito lento." }, { text: "Um tipo de vírus de boot antigo.", isCorrect: false, exp: "Spooling é uma técnica fundamental de otimização de SO." } ] },
                { q: "Qual foi o salto tecnológico principal que viabilizou a Multiprogramação nas arquiteturas de hardware?", options: [ { text: "A invenção do Rato (Mouse).", isCorrect: false, exp: "O rato afetou a interface, mas não a gestão interna da CPU." }, { text: "A proteção de memória e o hardware de Interrupções (Interrupts).", isCorrect: true, exp: "Correto! Sem a capacidade de interromper um processo em execução e proteger a memória de outros programas, a CPU não poderia alternar tarefas com segurança." } ] }
            ],
            level3: [ 
                { q: "Qual é a definição estrutural de um Sistema de Múltiplos Processadores 'Fortemente Acoplado'?", options: [ { text: "Processadores interconectados por uma rede WAN que não partilham o mesmo relógio.", isCorrect: false, exp: "Esta é a definição de fracamente acoplado (Sistemas Distribuídos)." }, { text: "Vários processadores que compartilham fisicamente a mesma memória principal (RAM) e o mesmo relógio (clock).", isCorrect: true, exp: "Exato! Exemplos clássicos são os processadores multicore dos PCs e smartphones modernos." } ] },
                { q: "Em relação à topologia de Multiprocessamento Simétrico (SMP), marque a afirmação academicamente correta:", options: [ { text: "Existe um processador Mestre que gere o S.O., enquanto os outros (Escravos) apenas executam aplicações.", isCorrect: false, exp: "Isso descreve o modelo Assimétrico (Master/Slave)." }, { text: "Todos os processadores são iguais perante o S.O.; qualquer processador pode executar tanto código do utilizador quanto código do SO.", isCorrect: true, exp: "Correto! O SMP oferece melhor balanceamento de carga e evita gargalos centralizados." } ] },
                { q: "O que define rigorosamente os Sistemas 'Fracamente Acoplados'?", options: [ { text: "Máquinas completas e independentes (nós), com RAM e S.O. próprios, que se comunicam através de uma infraestrutura de rede (ex: Clusters).", isCorrect: true, exp: "Perfeito! A principal vantagem é a altíssima tolerância a falhas e escalabilidade modular." }, { text: "Processadores que estão mal conectados no soquete da motherboard.", isCorrect: false, exp: "Trata-se de um conceito lógico de arquitetura, não de um defeito físico." } ] },
                { q: "Num ambiente de rede gerido por um S.O. de Rede (NOS - Network OS), qual é o paradigma predominante?", options: [ { text: "O utilizador tem de estar ciente de que está a aceder a recursos num servidor remoto.", isCorrect: true, exp: "Correto! Ao contrário do SO Distribuído (que esconde a rede e finge ser um computador único), no SO de Rede a distinção entre local e remoto é explícita." }, { text: "Todos os computadores da rede fundem as suas memórias RAM numa única memória virtual partilhada.", isCorrect: false, exp: "Isso seria característico de uma arquitetura estritamente distribuída (DSM)." } ] }
            ],
            level4: [ 
                { q: "Na arquitetura tradicional do UNIX, a estrutura de um processo na memória é segmentada para eficiência. Quais são essas partes fundamentais?", options: [ { text: "Structure Process (sempre residente na memória) e User Area (que pode sofrer swap/paginação para o disco).", isCorrect: true, exp: "Correto! A estrutura base não pode sair da RAM para que o Kernel nunca perca o rastreio do processo, mesmo se a área de dados do utilizador for para o disco." }, { text: "Kernel Central e Interface Shell.", isCorrect: false, exp: "Esta é a divisão do SO como um todo, não da memória de um processo." } ] },
                { q: "Qual inovação de arquitetura base o Windows NT / 2000 introduziu para aumentar a sua estabilidade comercial?", options: [ { text: "Transição para um design baseado em Micronúcleo (Microkernel) modificado, onde serviços e drivers rodam de forma mais isolada.", isCorrect: true, exp: "Exato! Apesar de ser um modelo híbrido na prática, a base microkernel reduziu a probabilidade de uma falha de driver derrubar todo o sistema." }, { text: "Adotou o Kernel Monolítico integral idêntico ao Linux original.", isCorrect: false, exp: "O Windows NT distanciou-se do modelo puramente monolítico para garantir modularidade." } ] },
                { q: "Segundo os teóricos de Ciência da Computação (e a bibliografia da Anhanguera), qual é a nuance entre 'Software Livre' e 'Open Source'?", options: [ { text: "Open Source impede qualquer tipo de comercialização do software.", isCorrect: false, exp: "A licença Open Source permite frequentemente o uso e venda comercial." }, { text: "O Software Livre (Free Software) tem raízes filosóficas na liberdade incondicional do utilizador; o Open Source é focado na pragmática do desenvolvimento (código aberto), permitindo regras de licenciamento e restrições de marca comercial.", isCorrect: true, exp: "Correto! O movimento Open Source foca-se na eficiência da engenharia de software aberta, não apenas na ética de liberdade total." } ] },
                { q: "O que motivou Linus Torvalds a criar o núcleo (kernel) Linux inicialmente?", options: [ { text: "O desejo de criar um monopólio para destruir a Microsoft nos anos 90.", isCorrect: false, exp: "Torvalds iniciou o projeto como um hobby estritamente pessoal e académico." }, { text: "A necessidade de possuir um sistema semelhante ao UNIX (inspirado no MINIX) que rodasse de forma nativa e livre nos processadores Intel 386.", isCorrect: true, exp: "Exato! Foi um projeto focado em arquitetura x86 e partilhado de forma aberta na Usenet." } ] }
            ],
            level5: [ 
                { q: "Defina estritamente o que é o 'Kernel' num Sistema Operacional moderno:", options: [ { text: "É o núcleo central privilegiado, responsável pela gestão dos processos, alocação de memória RAM e acesso direto ao hardware.", isCorrect: true, exp: "Exato! É o 'coração' da máquina. Se o Kernel entrar em pânico (Kernel Panic), o sistema operativo para completamente." }, { text: "É a camada gráfica (GUI) que desenha as janelas e os botões no ecrã.", isCorrect: false, exp: "A interface gráfica é uma camada de software (User Space), muito acima das permissões do Kernel." } ] },
                { q: "Para que um programa comum consiga ler um ficheiro no disco rígido, ele não pode acessar o hardware diretamente. Qual é o mecanismo rigoroso que o S.O. exige?", options: [ { text: "A realização de uma System Call (Chamada de Sistema), provocando uma interrupção por software que transita o processador para o Modo Kernel temporariamente.", isCorrect: true, exp: "Perfeito! A System Call é a API segura do Kernel. O programa pede e o Kernel valida os privilégios antes de executar a ação." }, { text: "O programa tem de utilizar o browser nativo do sistema para fazer um download local.", isCorrect: false, exp: "Falso." } ] },
                { q: "Qual é a distinção técnica principal entre os controladores (Drivers de Dispositivos)?", options: [ { text: "Traduzir instruções padronizadas do Kernel em sinais elétricos específicos e comandos proprietários que um hardware particular entenda.", isCorrect: true, exp: "Correto! O Kernel manda 'Ler Bloco X', e o driver sabe exatamente como movimentar a agulha ou enviar os sinais para o chip daquela marca específica." }, { text: "Eles atualizam o software antivírus do sistema operativo em segundo plano.", isCorrect: false, exp: "Incorreto. A sua função é estritamente comunicação de hardware." } ] },
                { q: "O que representa o 'Modo Usuário' (User Mode) em contraste com o 'Modo Kernel' (Kernel Mode) nos processadores atuais?", options: [ { text: "No Modo Usuário, as instruções executadas têm restrições severas e não podem alterar a memória de outros programas nem comunicar com os periféricos diretamente.", isCorrect: true, exp: "Exato! Esta divisão de hardware é a base da segurança e estabilidade dos sistemas operativos modernos." }, { text: "Modo Usuário é apenas quando o ecrã está ligado, e o Modo Kernel é quando o PC entra em suspensão (sleep).", isCorrect: false, exp: "Falso. São modos de execução de instruções na CPU em microssegundos." } ] },
                { q: "O que é o 'Shell' do Sistema Operacional e onde reside?", options: [ { text: "É a interface primária (linha de comandos ou gráfica) que recebe os comandos do humano. Ele opera em Modo Usuário.", isCorrect: true, exp: "Correto! O Shell interpreta as suas intenções e empacota-as em System Calls para o Kernel." }, { text: "É uma camada física colocada sobre o processador para evitar o superaquecimento.", isCorrect: false, exp: "Isso é dissipação térmica de hardware, não Shell." } ] }
            ]
        };

        // --- MAPAS CORRIGIDOS PARA GARANTIR CONECTIVIDADE ---
        const BASE_LEVELS = [
            { name: 'Fundamentos', pool: 'level1', map: [
                [1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,1,5,0,0,5,1],
                [1,1,1,1,0,1,0,1,1,0,1],
                [1,5,0,0,0,4,0,0,1,0,1],
                [1,0,1,1,1,1,1,0,1,0,1],
                [1,0,0,5,0,0,4,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1]
            ]},
            { name: 'Lote e Monotarefa', pool: 'level2', map: [
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,1,5,0,0,4,5,0,3,1],
                [1,0,0,1,0,1,1,1,1,1,0,1],
                [1,0,1,1,0,0,0,6,1,5,0,1],
                [1,0,0,4,1,1,1,0,1,0,1,1],
                [1,5,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1]
            ]},
            { name: 'Multiprocessamento', pool: 'level3', map: [
                [1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,1,5,0,4,0,1,5,3,1],
                [1,1,1,0,1,0,1,1,0,1,0,0,1],
                [1,5,4,0,0,0,1,6,0,0,1,0,1],
                [1,0,1,1,1,0,1,1,1,0,1,0,1],
                [1,0,0,5,4,0,0,0,5,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1]
            ]},
            { name: 'UNIX & Win2000', pool: 'level4', map: [
                [1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,5,1,5,0,1,5,0,4,3,1],
                [1,0,1,0,1,0,0,1,0,1,1,0,1],
                [1,0,4,0,0,1,0,0,0,6,5,0,1],
                [1,0,1,1,0,1,1,1,1,1,1,1,1],
                [1,5,0,0,0,4,0,5,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1]
            ]},
            { name: 'O Núcleo (Kernel)', pool: 'level5', map: [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,1,5,0,4,0,1,5,0,4,3,1],
                [1,1,1,0,1,0,1,1,0,1,0,1,1,0,1],
                [1,5,4,0,0,0,6,1,0,0,0,5,1,0,1],
                [1,0,1,1,1,1,0,1,1,1,1,0,1,0,1],
                [1,0,0,5,0,0,0,4,5,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ]}
        ];

        // --- ESTADO GLOBAL ---
        const state = {
            user: null,
            gameState: 'loading',
            progress: { xp: 0, maxFloor: 1 },
            currentFloor: 1,
            grid: [],
            playerPos: { r: 1, c: 1 },
            hp: 100,
            combo: 0,
            activeBugCoords: null,
            availableQuestionsForFloor: [], // CONTROLE DO BARALHO (SHUFFLE/POP)
            currentQuestion: null,
            selectedOption: null,
            isFeedbackMode: false
        };

        window.bugInterval = null;

        // --- FIREBASE SETUP ---
        const userConfig = {
            apiKey: "AIzaSyDkhunNCZU_hnitI8IC51b7Z0DBf_J4PSE",
            authDomain: "thegame533-1a48a.firebaseapp.com",
            projectId: "thegame533-1a48a",
            storageBucket: "thegame533-1a48a.firebasestorage.app",
            messagingSenderId: "204096520106",
            appId: "1:204096520106:web:34e8155a5dc1b8767a75d3"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userConfig;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'kernel-explorer-anhanguera';

        // --- ANIMAÇÕES GERAIS ---
        function spawnFloatingText(text, colorClass) {
            const container = document.getElementById('float-container');
            const el = document.createElement('div');
            el.className = `floating-text ${colorClass} text-xl md:text-3xl`;
            el.innerText = text;
            el.style.left = `${30 + Math.random() * 40}%`;
            el.style.top = `${30 + Math.random() * 20}%`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        function triggerScreenShake() {
            const main = document.getElementById('main-content');
            main.classList.remove('animate-shake');
            void main.offsetWidth;
            main.classList.add('animate-shake');
        }

        // --- AUTH ---
        window.handleAuth = async (action, event) => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorDiv = document.getElementById('auth-error');

            if (!email || !password) {
                errorDiv.innerText = "Por favor, preencha o e-mail e a senha.";
                errorDiv.classList.remove('hidden');
                return;
            }

            errorDiv.classList.add('hidden');
            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i class="ph ph-spinner animate-spin"></i> Processando...`;
            btn.disabled = true;

            try {
                if (action === 'login') await signInWithEmailAndPassword(auth, email, password);
                else if (action === 'register') await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Auth erro:", error);
                let msg = "Falha na autenticação.";
                if (error.code === 'auth/email-already-in-use') msg = "Este e-mail já está cadastrado.";
                else if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') msg = "Credenciais inválidas.";
                else if (error.code === 'auth/weak-password') msg = "A senha deve ter pelo menos 6 caracteres.";
                
                errorDiv.innerText = msg;
                errorDiv.classList.remove('hidden');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        window.logout = async () => {
            clearBugInterval();
            await signOut(auth);
            state.user = null;
            state.progress = { xp: 0, maxFloor: 1 };
            
            document.getElementById('auth-email').value = '';
            document.getElementById('auth-password').value = '';
            document.getElementById('auth-error').classList.add('hidden');
            
            const btns = document.querySelectorAll('#auth-form button');
            btns.forEach(b => { 
                b.disabled = false; 
                if(b.innerText.includes('Processando')) {
                    b.innerHTML = b.innerHTML.replace('Processando...', b.onclick.toString().includes('login') ? 'Entrar' : 'Novo');
                }
            });
            setGameState('auth');
        };

        // --- GLOBAL LOGIC ---
        window.setGameState = (newState) => {
            state.gameState = newState;
            updateUI();
        };

        // --- GAMEPLAY MECHANICS ---
        window.startLevel = () => {
            if(state.gameState === 'dashboard') {
                state.currentFloor = state.progress.maxFloor || 1; 
                state.hp = 100;
                state.combo = 0;
            }

            const levelIdx = (state.currentFloor - 1) % BASE_LEVELS.length;
            const baseLevel = BASE_LEVELS[levelIdx];
            
            // Embaralhar o "deck" de questões do nível para não haver repetidas
            const pool = [...QUESTIONS_POOL[baseLevel.pool]];
            pool.sort(() => Math.random() - 0.5);
            state.availableQuestionsForFloor = pool;

            // Deep copy map
            state.grid = baseLevel.map.map(row => [...row]);

            // Dificuldade Escalonável Infinitamente
            let extraBugs = Math.floor((state.currentFloor - 1) / BASE_LEVELS.length) * 2;
            while(extraBugs > 0) {
                let r = Math.floor(Math.random() * state.grid.length);
                let c = Math.floor(Math.random() * state.grid[0].length);
                if (state.grid[r][c] === 0) {
                    state.grid[r][c] = 4;
                    extraBugs--;
                }
            }

            // Localizar Posição Inicial
            for(let r=0; r < state.grid.length; r++) {
                for(let c=0; c < state.grid[r].length; c++) {
                    if(state.grid[r][c] === 2) {
                        state.playerPos = { r, c };
                        state.grid[r][c] = 0; 
                    }
                }
            }

            state.gameState = 'playing';
            updateUI();
            
            clearBugInterval();
            let aiSpeed = Math.max(650, 1100 - (state.currentFloor * 30));
            window.bugInterval = setInterval(moveBugs, aiSpeed);
        };

        window.abortGame = () => {
            clearBugInterval();
            setGameState('dashboard');
        };

        window.nextFloor = () => {
            state.currentFloor++;
            saveProgress(500, state.currentFloor);
            startLevel();
        };

        function clearBugInterval() {
            if (window.bugInterval) {
                clearInterval(window.bugInterval);
                window.bugInterval = null;
            }
        }

        // INTELIGÊNCIA ARTIFICIAL: COMPORTAMENTO DOS BUGS
        function moveBugs() {
            if (state.gameState !== 'playing') return;

            let bugs = [];
            for (let r = 0; r < state.grid.length; r++) {
                for (let c = 0; c < state.grid[r].length; c++) {
                    if (state.grid[r][c] === 4) bugs.push({r, c});
                }
            }

            let triggeredBattleThisTick = false;

            bugs.forEach(bug => {
                if (triggeredBattleThisTick) return;

                let dr = state.playerPos.r - bug.r;
                let dc = state.playerPos.c - bug.c;

                let possibleMoves = [];
                if (Math.abs(dr) > 0) possibleMoves.push({ r: bug.r + Math.sign(dr), c: bug.c });
                if (Math.abs(dc) > 0) possibleMoves.push({ r: bug.r, c: bug.c + Math.sign(dc) });

                possibleMoves.sort(() => Math.random() - 0.5);

                for (let move of possibleMoves) {
                    if (move.r === state.playerPos.r && move.c === state.playerPos.c) {
                        triggerBattle(bug.r, bug.c);
                        triggeredBattleThisTick = true;
                        break;
                    }
                    if (state.grid[move.r][move.c] === 0) {
                        state.grid[bug.r][bug.c] = 0;
                        state.grid[move.r][move.c] = 4;
                        break;
                    }
                }
            });

            if (!triggeredBattleThisTick) {
                renderGrid(); 
            }
        }

        function triggerBattle(r, c) {
            clearBugInterval(); 
            state.activeBugCoords = { r, c };
            
            // Garantir que a lista de questões do piso atual tem dados (se esvaziar, re-embaralhamos)
            if (!state.availableQuestionsForFloor || state.availableQuestionsForFloor.length === 0) {
                const levelIdx = (state.currentFloor - 1) % BASE_LEVELS.length;
                state.availableQuestionsForFloor = [...QUESTIONS_POOL[BASE_LEVELS[levelIdx].pool]].sort(() => Math.random() - 0.5);
            }
            
            // Pop the top question
            state.currentQuestion = state.availableQuestionsForFloor.pop();
            
            state.selectedOption = null;
            state.isFeedbackMode = false;
            state.gameState = 'battle';
            updateUI();
        }

        window.movePlayer = (dr, dc) => {
            if (state.gameState !== 'playing') return;

            const newR = state.playerPos.r + dr;
            const newC = state.playerPos.c + dc;

            if (newR < 0 || newR >= state.grid.length || newC < 0 || newC >= state.grid[0].length) return;

            const targetCell = state.grid[newR][newC];
            if (targetCell === 1) return; // Parede

            if (targetCell === 5) { // Moeda
                state.grid[newR][newC] = 0;
                const xpGain = 10 * (state.combo > 0 ? state.combo : 1);
                saveProgress(xpGain, state.progress.maxFloor);
                spawnFloatingText(`+${xpGain} BITS`, 'text-yellow-400');
                state.playerPos = { r: newR, c: newC };
            } 
            else if (targetCell === 6) { // Cura
                state.grid[newR][newC] = 0;
                const heal = 34;
                state.hp = Math.min(100, state.hp + heal);
                spawnFloatingText(`+${heal} HP`, 'text-emerald-400');
                updateHUD();
                state.playerPos = { r: newR, c: newC };
            }
            else if (targetCell === 4) { // Colisão c/ Inimigo
                triggerBattle(newR, newC);
                return; 
            } 
            else if (targetCell === 3) { // Saída
                clearBugInterval();
                state.gameState = 'level-complete';
                updateUI();
                return;
            } 
            else { // Vazio
                state.playerPos = { r: newR, c: newC };
            }
            
            renderGrid();
        };

        window.handleAnswer = (idx) => {
            if (state.isFeedbackMode) return;
            state.selectedOption = idx;
            state.isFeedbackMode = true;
            renderBattleOptions();
        };

        window.closeBattleFeedback = () => {
            const isCorrect = state.currentQuestion.options[state.selectedOption].isCorrect;
            if (isCorrect) {
                state.combo += 1;
                const xpGain = 50 * state.combo;
                saveProgress(xpGain, state.progress.maxFloor);
                spawnFloatingText(`COMBO x${state.combo}!`, 'text-orange-500');
                
                // Expurga o bug
                state.grid[state.activeBugCoords.r][state.activeBugCoords.c] = 0;
                state.playerPos = { r: state.activeBugCoords.r, c: state.activeBugCoords.c };
                state.gameState = 'playing';
                
                // Retoma o movimento
                let aiSpeed = Math.max(650, 1100 - (state.currentFloor * 30));
                window.bugInterval = setInterval(moveBugs, aiSpeed);
            } else {
                state.combo = 0;
                triggerScreenShake();
                state.hp -= 34;
                
                if (state.hp <= 0) {
                    state.gameState = 'game-over';
                } else {
                    state.gameState = 'playing';
                    let aiSpeed = Math.max(650, 1100 - (state.currentFloor * 30));
                    window.bugInterval = setInterval(moveBugs, aiSpeed);
                }
            }
            updateUI();
        };

        window.addEventListener('keydown', (e) => {
            if (state.gameState !== 'playing') return;
            switch(e.key) {
                case 'ArrowUp': case 'w': e.preventDefault(); window.movePlayer(-1, 0); break;
                case 'ArrowDown': case 's': e.preventDefault(); window.movePlayer(1, 0); break;
                case 'ArrowLeft': case 'a': e.preventDefault(); window.movePlayer(0, -1); break;
                case 'ArrowRight': case 'd': e.preventDefault(); window.movePlayer(0, 1); break;
            }
        });

        // --- FIREBASE SYNC ---
        async function initApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                }
            } catch (e) {
                console.error("Auth Erro Init:", e);
            }
        }

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                const ref = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'gameData', 'progressV2');
                onSnapshot(ref, (snap) => {
                    if (snap.exists()) {
                        state.progress = snap.data();
                        if(!state.progress.maxFloor) state.progress.maxFloor = 1;
                    } else {
                        setDoc(ref, { xp: 0, maxFloor: 1 });
                        state.progress = { xp: 0, maxFloor: 1 };
                    }
                    
                    if (state.gameState === 'loading' || state.gameState === 'auth') {
                        state.gameState = 'dashboard';
                        updateUI();
                    } else {
                        updateHUD();
                        if(state.gameState === 'dashboard') renderDashboard(); 
                    }
                }, (error) => {
                    console.error("Firestore error:", error);
                });
            } else {
                clearBugInterval();
                state.gameState = 'auth';
                updateUI();
            }
        });

        async function saveProgress(xpAmount, floorReached = state.progress.maxFloor) {
            if (!state.user) return;
            const ref = doc(db, 'artifacts', APP_ID, 'users', state.user.uid, 'gameData', 'progressV2');
            
            state.progress.xp += xpAmount;
            if (floorReached > state.progress.maxFloor) {
                state.progress.maxFloor = floorReached;
            }
            updateHUD();

            await setDoc(ref, {
                xp: state.progress.xp,
                maxFloor: state.progress.maxFloor
            }, { merge: true });
        }

        // --- RENDERING ---
        function updateUI() {
            ['loading', 'auth', 'dashboard', 'playing', 'battle', 'game-over', 'level-complete'].forEach(id => {
                document.getElementById(`screen-${id}`).classList.add('hidden');
            });
            
            const hud = document.getElementById('hud');
            if (state.gameState === 'loading' || state.gameState === 'auth') {
                hud.classList.add('hidden');
            } else {
                hud.classList.remove('hidden');
                updateHUD();
            }

            const currentScreen = document.getElementById(`screen-${state.gameState}`);
            if(currentScreen) currentScreen.classList.remove('hidden');

            if (state.gameState === 'dashboard') renderDashboard();
            if (state.gameState === 'playing') {
                const levelIdx = (state.currentFloor - 1) % BASE_LEVELS.length;
                document.getElementById('playing-level-name').innerText = `Tema: ${BASE_LEVELS[levelIdx].name}`;
                renderGrid();
            }
            if (state.gameState === 'battle') renderBattleScreen();
        }

        function renderDashboard() {
            document.getElementById('dash-max-floor').innerText = state.progress.maxFloor;
            document.getElementById('dash-xp').innerText = state.progress.xp;
        }

        function updateHUD() {
            if (!state.user) return;
            
            document.getElementById('hud-level-text').innerText = `SETOR ${state.currentFloor}`;
            document.getElementById('hud-xp').innerText = state.progress.xp;
            
            const comboEl = document.getElementById('hud-combo');
            const comboMult = document.getElementById('combo-multiplier');
            if (state.combo > 1 && state.gameState === 'playing') {
                comboEl.classList.remove('hidden');
                comboEl.classList.add('flex');
                comboMult.innerText = state.combo;
            } else {
                comboEl.classList.add('hidden');
                comboEl.classList.remove('flex');
            }
            
            const hpContainer = document.getElementById('hud-hp-container');
            const hpText = document.getElementById('hud-hp');
            
            if (state.gameState === 'dashboard') {
                hpContainer.classList.add('hidden');
            } else {
                hpContainer.classList.remove('hidden');
                hpText.innerText = Math.max(0, state.hp);
                
                hpContainer.className = `flex items-center gap-2 px-3 sm:px-4 py-1.5 rounded-lg border font-bold shadow-inner transition-all duration-300 ${
                    state.hp > 35 
                    ? 'bg-emerald-900/30 border-emerald-500/50 text-emerald-400' 
                    : 'bg-red-900/30 border-red-500/50 text-red-400 animate-pulse'
                }`;
            }
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            container.style.gridTemplateColumns = `repeat(${state.grid[0].length}, minmax(0, 1fr))`;

            state.grid.forEach((row, r) => {
                row.forEach((cell, c) => {
                    const isPlayer = state.playerPos.r === r && state.playerPos.c === c;
                    
                    const div = document.createElement('div');
                    let cellClasses = "w-6 h-6 sm:w-8 sm:h-8 md:w-12 md:h-12 flex items-center justify-center rounded-sm sm:rounded transition-all duration-200 relative overflow-hidden ";
                    let iconHTML = "";

                    if (isPlayer) {
                        cellClasses += "bg-cyan-500/20 shadow-[inset_0_0_15px_rgba(0,255,255,0.4)] z-10 border border-cyan-500/50";
                        iconHTML = `<i class="ph-fill ph-terminal-window text-cyan-400 text-lg md:text-2xl drop-shadow-[0_0_8px_rgba(0,255,255,1)]"></i>`;
                    } 
                    else if (cell === 1) { 
                        cellClasses += "bg-slate-800 border border-slate-700/50";
                        iconHTML = `<i class="ph-fill ph-hard-drives text-slate-700/50 text-xs md:text-lg"></i>`;
                    } 
                    else if (cell === 5) { 
                        cellClasses += "bg-yellow-900/10";
                        iconHTML = `<i class="ph-fill ph-database text-yellow-500 animate-pulse drop-shadow-[0_0_8px_rgba(234,179,8,0.7)] text-sm md:text-xl"></i>`;
                    } 
                    else if (cell === 6) { 
                        cellClasses += "bg-emerald-900/10";
                        iconHTML = `<i class="ph-fill ph-heart text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.7)] text-sm md:text-xl animate-pulse"></i>`;
                    }
                    else if (cell === 4) { 
                        cellClasses += "bg-red-900/20";
                        iconHTML = `<i class="ph-fill ph-bug text-red-500 drop-shadow-[0_0_10px_rgba(239,68,68,0.9)] animate-bug text-base md:text-2xl"></i>`;
                    } 
                    else if (cell === 3) { 
                        cellClasses += "bg-emerald-900/30 border border-emerald-500/40";
                        iconHTML = `<i class="ph-fill ph-door-open text-emerald-400 drop-shadow-[0_0_10px_rgba(16,185,129,0.8)] text-base md:text-2xl"></i>`;
                    } 
                    else { 
                        cellClasses += "bg-slate-900/50";
                    }

                    div.className = cellClasses;
                    div.innerHTML = iconHTML;
                    container.appendChild(div);
                });
            });
        }

        function renderBattleScreen() {
            document.getElementById('battle-question').innerText = state.currentQuestion.q;
            document.getElementById('battle-feedback-panel').classList.add('hidden');
            renderBattleOptions();
        }

        function renderBattleOptions() {
            const container = document.getElementById('battle-options');
            container.innerHTML = '';
            
            state.currentQuestion.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                let btnClass = "w-full text-left p-4 md:p-5 rounded-2xl border-2 transition-all duration-200 text-base md:text-lg font-sans font-medium ";
                
                if (!state.isFeedbackMode) {
                    btnClass += "bg-slate-800 border-slate-700 hover:border-cyan-500 hover:bg-slate-700 hover:-translate-y-1 hover:shadow-lg";
                } else {
                    if (opt.isCorrect) btnClass += "bg-emerald-900/40 border-emerald-500 text-emerald-100 shadow-[0_0_15px_rgba(16,185,129,0.2)]";
                    else if (idx === state.selectedOption) btnClass += "bg-red-900/40 border-red-500 text-red-100 shadow-[0_0_15px_rgba(239,68,68,0.2)]";
                    else btnClass += "bg-slate-800/50 border-slate-800 opacity-40";
                }

                btn.className = btnClass;
                btn.innerText = opt.text;
                if (!state.isFeedbackMode) btn.onclick = () => window.handleAnswer(idx);
                container.appendChild(btn);
            });

            if (state.isFeedbackMode) renderBattleFeedback();
        }

        function renderBattleFeedback() {
            const panel = document.getElementById('battle-feedback-panel');
            const box = document.getElementById('feedback-box');
            const icon = document.getElementById('feedback-icon');
            const title = document.getElementById('feedback-title');
            const text = document.getElementById('feedback-text');
            const warning = document.getElementById('feedback-warning');
            const btnContinue = document.getElementById('btn-continue-battle');

            const isCorrect = state.currentQuestion.options[state.selectedOption].isCorrect;

            panel.classList.remove('hidden');
            text.innerText = state.currentQuestion.options[state.selectedOption].exp;

            if (isCorrect) {
                box.className = "p-6 md:p-8 rounded-2xl border-2 mb-6 shadow-[0_10px_30px_rgba(16,185,129,0.1)] bg-emerald-950/80 border-emerald-800 text-emerald-100";
                icon.className = "ph-fill ph-check-circle text-emerald-500";
                title.innerText = "Bug Expurgado";
                warning.classList.add('hidden');
                btnContinue.innerText = "Avançar";
            } else {
                box.className = "p-6 md:p-8 rounded-2xl border-2 mb-6 shadow-[0_10px_30px_rgba(239,68,68,0.1)] bg-red-950/80 border-red-800 text-red-100";
                icon.className = "ph-fill ph-warning-octagon text-red-500";
                title.innerText = "Dano Crítico (-34 HP)";
                warning.classList.remove('hidden');
                btnContinue.innerText = "Recuar e Absorver a Falha";
            }
        }

        initApp();

    </script>
</body>
</html>
